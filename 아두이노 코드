#include <WiFi.h>
#include <WebServer.h>
#include <DHT.h>

// ===========================
// Wi-Fi ì •ë³´
// ===========================
const char* ssid = "dudrlf";
const char* password = "00000000";

// ===========================
// DHT ì„¤ì •
// ===========================
#define DHTPIN 10         // DHT11 ì„¼ì„œê°€ ì—°ê²°ëœ ì•„ë‘ì´ë…¸ í•€ ë²ˆí˜¸ë¥¼ 10ë²ˆìœ¼ë¡œ ì§€ì •
#define DHTTYPE DHT11     //ì‚¬ìš©í•  ì„¼ì„œ ì¢…ë¥˜ë¥¼ DHT11ìœ¼ë¡œ ì§€ì •
DHT dht(DHTPIN, DHTTYPE);

// ===========================
// HTTP ì„œë²„
// ===========================
WebServer server(80); //80ë²ˆ í¬íŠ¸ë¡œ ì›¹ì„œë²„ ì‹¤í–‰

// JSON ë°˜í™˜ í•¸ë“¤ëŸ¬
void handleSensorData() {
  float temperature = dht.readTemperature(); // ì˜¨ë„ì™€ìŠµë„ ê°’ì„ ì„¼ì„œì—ì„œ ì½ì–´ì˜¤ëŠ”ì½”ë“œ
  float humidity = dht.readHumidity();

  if (isnan(temperature) || isnan(humidity)) {
    server.send(500, "application/json", "{\"error\":\"Sensor read failed\"}");
    return;
  }

  String json = "{";
  json += "\"temperature\":" + String(temperature) + ","; //ì˜¨ë„ì™€ ìŠµë„ ê°’ì„ JSON í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ë§Œë“­ë‹ˆë‹¤.
  json += "\"humidity\":" + String(humidity);
  json += "}";

  server.sendHeader("Access-Control-Allow-Origin", "*");  // CORS ì •ì±…ì„ í—ˆìš©í•´, ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œë„ ì´ ë°ì´í„°ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆê²Œ ë§Œë“­ë‹ˆë‹¤.
  server.send(200, "application/json", json);
}

void setup() {
  Serial.begin(115200);
  dht.begin();

  WiFi.begin(ssid, password);  // ì´ì½”ë“œëŠ” ESP32ê°€ ë¬´ì„  ì¸í„°ë„·(Wi-Fi)ì— ì—°ê²°ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤
  Serial.print("WiFi ì—°ê²° ì¤‘"); 
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ… WiFi ì—°ê²°ë¨: " + WiFi.localIP().toString());

  server.on("/data", handleSensorData); //ì‚¬ìš©ìê°€ /data ì£¼ì†Œë¡œ ì ‘ì†í–ˆì„ ë•Œ ì‹¤í–‰í•  í•¨ìˆ˜ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
  server.begin();
  Serial.println("ğŸŒ ì›¹ì„œë²„ ì‹¤í–‰ ì¤‘...");
}

void loop() {
  server.handleClient();
}
